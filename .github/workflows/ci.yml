# File: .github/workflows/flutter_ci_cd.yaml

name: Flutter CI/CD Pipeline

# Kích hoạt workflow khi có push hoặc pull request lên nhánh main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    
# Định nghĩa các biến môi trường (Environment Variables) chung
env:
  FLUTTER_VERSION: '3.x' # Phiên bản Flutter bạn đang sử dụng (ví dụ: 3.16.5)

jobs:
  # =======================================================
  # JOB 1: CI - Build, Analyze, and Test (Chạy trong mọi trường hợp)
  # =======================================================
  build_and_test:
    name: Build & Test
    runs-on: ubuntu-latest # Sử dụng máy ảo Ubuntu
    
    steps:
    - name:  Checkout Mã nguồn
      uses: actions/checkout@v4

    - name: Thiết lập Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Lấy Dependencies
      run: flutter pub get

    - name: Chạy Flutter Analyze
      run: flutter analyze

    - name: Chạy Unit và Widget Tests
      run: flutter test

  # =======================================================
  # JOB 2: CD - Build và Deploy Android (Chỉ chạy khi merge vào main)
  # =======================================================
  deploy_android:
    name: Deploy Android APK
    needs: build_and_test # Phải đảm bảo Job 1 thành công trước
    # Điều kiện: Chỉ chạy nếu sự kiện là push (không phải PR) và đẩy lên nhánh main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' 
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Mã nguồn
      uses: actions/checkout@v4

    - name: Thiết lập Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Lấy Dependencies
      run: flutter pub get
      
    # Cần thiết lập Firebase Service Account (xem mục 2)
    - name: Cung cấp Khóa Dịch vụ Firebase
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}
        
    - name: Build Android Release (APK)
      # Lưu ý: Cần khóa ký (signing keys) nếu bạn muốn đẩy lên Play Store, nhưng cho App Distribution thì APK thường là đủ.
      run: flutter build apk --release

    - name: Triển khai lên Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_ANDROID_APP_ID }} # ID ứng dụng Firebase Android
        token: ${{ secrets.FIREBASE_CLI_TOKEN }}     # Token đăng nhập CLI (Xem mục 3)
        group: 'testers' # Tên nhóm người thử nghiệm
        file: build/app/outputs/flutter-apk/app-release.apk # Đường dẫn file APK